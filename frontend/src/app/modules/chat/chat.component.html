<div class="chat-container">
  <!-- Header -->
  <div
    class="border-b border-slate-200 dark:border-slate-800 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md p-4 sticky top-0 z-10"
  >
    <div class="max-w-4xl mx-auto flex justify-between items-center">
      <!-- Identity -->
      <div class="flex items-center gap-3 cursor-pointer group" (click)="toggleAgentInfoModal()">
        <div
          class="w-10 h-10 rounded-full bg-slate-900 text-white flex items-center justify-center font-bold text-sm shadow-sm relative group-hover:scale-105 transition-transform"
        >
          AI
          @if (agentInfo()?.identity) {
            <div
              class="absolute -bottom-0.5 -right-0.5 w-3 h-3 bg-green-500 border-2 border-white rounded-full"
            ></div>
          }
        </div>
        <div>
          <div
            class="font-bold text-slate-900 dark:text-white text-sm group-hover:text-blue-600 transition-colors"
          >
            {{ agentInfo()?.identity?.name || 'Verifik Agent' }}
          </div>
          <div class="text-[11px] text-slate-500 font-medium">x402 Protocol</div>
        </div>
      </div>

      <!-- Wallet Widget -->
      <div
        class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 cursor-pointer hover:border-slate-300 transition-colors hover:shadow-sm"
        (click)="toggleWalletModal()"
      >
        <div class="text-xs font-medium text-slate-600 dark:text-slate-300 font-mono">
          {{ walletBalance() | number: '1.4-4' }} AVAX
        </div>
        <div
          class="w-6 h-6 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400"
        >
          <mat-icon class="!w-3.5 !h-3.5 !text-[14px]">account_balance_wallet</mat-icon>
        </div>
      </div>
    </div>
  </div>

  <!-- Agent Info Modal (ERC8004) -->
  @if (showAgentInfoModal()) {
    <div class="modal-overlay" (click)="toggleAgentInfoModal()">
      <div class="modal-content agent-info-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Agent Identity (ERC8004)</h2>
          <button class="close-button" (click)="toggleAgentInfoModal()">‚úï</button>
        </div>

        <div class="modal-body">
          @if (isLoadingAgentInfo()) {
            <div class="loading-state">Loading agent information...</div>
          } @else if (agentInfo()?.identity) {
            <div class="agent-identity">
              <div class="identity-section">
                <h3>Identity</h3>
                <div class="detail-item">
                  <label>Name</label>
                  <div class="detail-value">{{ agentInfo()?.identity?.name }}</div>
                </div>
                <div class="detail-item">
                  <label>Description</label>
                  <div class="detail-value">{{ agentInfo()?.identity?.description }}</div>
                </div>
                <div class="detail-item">
                  <label>Status</label>
                  <div class="detail-value">
                    <span
                      [class]="agentInfo()?.identity?.active ? 'status-active' : 'status-inactive'"
                    >
                      {{ agentInfo()?.identity?.active ? 'Active' : 'Inactive' }}
                    </span>
                  </div>
                </div>
                <div class="detail-item">
                  <label>Agent Address</label>
                  <div class="detail-value">
                    <code>{{ agentInfo()?.identity?.agentAddress }}</code>
                  </div>
                </div>
                <div class="detail-item">
                  <label>Registered</label>
                  <div class="detail-value">
                    {{ agentInfo()?.identity?.createdAt | date: 'medium' }}
                  </div>
                </div>
              </div>

              <div class="identity-section">
                <h3>Capabilities</h3>
                <div class="capabilities-list">
                  @for (cap of agentInfo()?.identity?.capabilities; track cap) {
                    <span class="capability-badge">{{ cap }}</span>
                  }
                </div>
              </div>

              @if (agentInfo()?.reputation) {
                <div class="identity-section">
                  <h3>Reputation</h3>
                  <div class="reputation-stats">
                    <div class="stat-item">
                      <label>Average Rating</label>
                      <div class="stat-value">
                        <strong>{{
                          agentInfo()?.reputation?.averageRating?.toFixed(2) || 'N/A'
                        }}</strong>
                        / 5.0
                      </div>
                    </div>
                    <div class="stat-item">
                      <label>Total Reviews</label>
                      <div class="stat-value">
                        <strong>{{ agentInfo()?.reputation?.totalFeedbacks || 0 }}</strong>
                      </div>
                    </div>
                    <div class="stat-item">
                      <label>Total Ratings</label>
                      <div class="stat-value">
                        <strong>{{ agentInfo()?.reputation?.totalRatings || 0 }}</strong>
                      </div>
                    </div>
                  </div>
                </div>
              }
              @if (agentInfo()?.feedbacks && (agentInfo()?.feedbacks)!.length > 0) {
                <div class="identity-section">
                  <h3>Recent Reviews</h3>
                  <div class="feedbacks-list">
                    @for (feedback of agentInfo()?.feedbacks; track feedback.id) {
                      <div class="feedback-item">
                        <div class="feedback-header">
                          <div class="feedback-rating">
                            @for (star of [1, 2, 3, 4, 5]; track star) {
                              <span [class.filled]="star <= feedback.rating">‚≠ê</span>
                            }
                          </div>
                          <div class="feedback-meta">
                            <span class="feedback-address"
                              >{{ feedback.client.substring(0, 6) }}...{{
                                feedback.client.substring(38)
                              }}</span
                            >
                            <span class="feedback-date">{{
                              feedback.timestamp | date: 'short'
                            }}</span>
                            @if (feedback.verified) {
                              <span class="verified-badge">‚úì Verified</span>
                            }
                          </div>
                        </div>
                        @if (feedback.tags && feedback.tags.length > 0) {
                          <div class="feedback-tags">
                            @for (tag of feedback.tags; track tag) {
                              <span class="tag-small">{{ tag }}</span>
                            }
                          </div>
                        }
                        @if (feedback.comment) {
                          <div class="feedback-comment-text">{{ feedback.comment }}</div>
                        }
                      </div>
                    }
                  </div>
                  <div class="view-all-link">
                    <a
                      href="https://testnet.snowtrace.io/address/0xc8AF65010D6Bf85e4DC89D9D13E9cC185df919B1#readContract"
                      target="_blank"
                      class="link-button-small"
                    >
                      View All on Snowtrace
                    </a>
                  </div>
                </div>
              }

              <div class="identity-section">
                <h3>Links</h3>
                <div class="links-list">
                  <a
                    href="https://testnet.snowtrace.io/token/0x7c6a168455C94092f8d51aBC515B73f4Ed9813a6?a=1"
                    target="_blank"
                    class="link-button"
                  >
                    View NFT on Snowtrace
                  </a>
                  <a [href]="agentCardUrl" target="_blank" class="link-button"> Agent Card JSON </a>
                </div>
              </div>
            </div>
          } @else {
            <div class="no-info">
              <p>Agent identity not available. The agent may not be registered on ERC8004.</p>
            </div>
          }
        </div>
      </div>
    </div>
  }

  <!-- Wallet Modal -->
  @if (showWalletModal()) {
    <div class="modal-overlay" (click)="toggleWalletModal()">
      <div
        class="w-full max-w-sm mx-auto p-6 bg-white dark:bg-slate-900 rounded-2xl shadow-2xl relative animate-slideUp"
        (click)="$event.stopPropagation()"
      >
        <!-- Close Button -->
        <button
          class="absolute right-4 top-4 text-slate-400 hover:text-slate-600 transition-colors"
          (click)="toggleWalletModal()"
        >
          <mat-icon>close</mat-icon>
        </button>

        <!-- Header -->
        <div class="text-center mb-6">
          <div
            class="w-12 h-12 bg-blue-50 text-blue-600 rounded-full mx-auto flex items-center justify-center mb-3"
          >
            <mat-icon>account_balance_wallet</mat-icon>
          </div>
          <h2 class="text-xl font-bold text-slate-900 dark:text-white">Agent Wallet</h2>
          <p class="text-xs text-slate-500 mt-1">x402 Protocol ‚Ä¢ Avalanche Fuji</p>
        </div>

        <!-- Content -->
        <div class="space-y-5">
          <!-- Address -->
          <div>
            <!-- QR Code -->
            @if (walletQrCode()) {
              <div class="flex justify-center mb-3">
                <div class="p-2 bg-white rounded-xl border border-slate-100 shadow-sm">
                  <img [src]="walletQrCode()" alt="Wallet Address QR" class="w-32 h-32" />
                </div>
              </div>
            }

            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1.5"
              >Wallet Address</label
            >

            <div
              class="flex items-center gap-2 p-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 group hover:border-blue-200 transition-colors"
            >
              <code
                class="text-xs text-slate-600 dark:text-slate-300 break-all flex-1 font-mono leading-relaxed"
              >
                {{ walletAddress() }}
              </code>
              <button
                class="p-2 hover:bg-white dark:hover:bg-slate-700 rounded-lg transition-all text-slate-400 hover:text-blue-600 shadow-sm opacity-0 group-hover:opacity-100"
                (click)="copyAddress()"
                matTooltip="Copy Address"
              >
                <mat-icon class="!w-4 !h-4 !text-[16px]">content_copy</mat-icon>
              </button>
            </div>
          </div>

          <!-- Balance -->
          <div>
            <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1.5"
              >Balance</label
            >
            <div
              class="p-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 flex flex-col items-center justify-center"
            >
              <div class="text-3xl font-bold text-slate-900 dark:text-white tracking-tight">
                {{ walletBalance() | number: '1.4-4' }}
              </div>
              <div class="text-xs font-medium text-slate-400 mt-1">AVAX</div>
            </div>
          </div>

          <!-- Actions -->
          <div class="grid grid-cols-2 gap-3 pt-2">
            <button
              mat-stroked-button
              class="w-full !h-10 !rounded-lg !border-slate-200 text-slate-600"
              (click)="refreshBalance()"
            >
              <mat-icon class="!w-4 !h-4 mr-2">refresh</mat-icon>
              Refresh
            </button>
            <button
              mat-stroked-button
              color="warn"
              class="w-full !h-10 !rounded-lg !border-red-100 text-red-600 bg-red-50/50"
              (click)="resetWallet()"
            >
              <mat-icon class="!w-4 !h-4 mr-2">delete_outline</mat-icon>
              Reset
            </button>
          </div>
        </div>

        <!-- Footer -->
        <div class="mt-6 pt-4 border-t border-slate-100 dark:border-slate-800 text-center">
          <div class="flex items-center justify-center gap-1.5 text-[10px] text-slate-400">
            <mat-icon class="!w-3 !h-3 !text-[12px]">verified_user</mat-icon>
            <span>Secured by Verifik</span>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Chat Area -->
  <div class="messages" #scrollContainer>
    @for (msg of messages(); track $index) {
      <div
        class="message"
        [class.user]="msg.role === 'user'"
        [class.system]="msg.role === 'system'"
      >
        <div class="message-bubble">
          <!-- Message Content -->
          <div class="message-content">{{ msg.content }}</div>

          <!-- Payment Request -->
          @if (msg.payment_required) {
            <div class="payment-request">
              <div class="payment-header"><span class="icon">‚ö°</span> Payment Required</div>
              <div class="payment-amount">
                Amount: <strong>{{ msg.payment_required.amount }} AVAX</strong>
              </div>
              <div class="payment-to">To: {{ msg.payment_required.receiver_address }}</div>
              <button class="pay-button" (click)="confirmPayment($index)">Pay & Proceed</button>
            </div>
          }

          <!-- Data Display -->
          @if (msg.data) {
            <div class="data-display">
              <pre>{{ msg.data | json }}</pre>
            </div>

            <!-- Proof Card (ERC8004) -->
            @if (msg.proof) {
              <div class="proof-card">
                <div class="proof-header">
                  <div class="proof-icon">
                    <mat-icon>verified_user</mat-icon>
                  </div>
                  <div class="proof-title">
                    <div class="proof-label">{{ 'proofCard.title' | transloco }}</div>
                    <div class="proof-network">{{ 'proofCard.network' | transloco }}</div>
                  </div>
                </div>
                <div class="proof-body">
                  <div class="proof-hash-row">
                    <span class="proof-hash-label">{{ 'proofCard.hashLabel' | transloco }}</span>
                    <a
                      [href]="'https://testnet.snowtrace.io/tx/' + msg.proof"
                      target="_blank"
                      class="proof-hash-value"
                    >
                      {{ msg.proof.substring(0, 10) }}...{{ msg.proof.substring(56) }}
                      <mat-icon class="inline-icon">open_in_new</mat-icon>
                    </a>
                  </div>
                  <div class="proof-status-row">
                    <span class="status-badge">
                      <mat-icon class="status-icon">check</mat-icon>
                      {{ 'proofCard.validated' | transloco }}
                    </span>
                  </div>
                </div>
              </div>
            }

            <!-- Feedback Button (show after successful tool execution) -->
            @if (msg.role === 'assistant' && msg.data) {
              <div class="feedback-prompt">
                <p>Was this helpful?</p>
                <button class="feedback-button" (click)="toggleFeedbackModal()">
                  ‚≠ê Rate & Review
                </button>
              </div>
            }
          }
        </div>
      </div>
    }

    <!-- Thinking Log (Visualization of thought process) -->
    @if (isLoading()) {
      <div class="message">
        <div class="message-bubble thinking-bubble">
          <div class="thinking-header">
            <div class="loading-dots">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
            <span class="thinking-status">{{ 'agentThinking.header' | transloco }}</span>
          </div>

          <!-- Steps Log -->
          <div class="thinking-steps">
            @for (step of thinkingSteps(); track $index) {
              <div class="step-item animate-fadeIn">
                <mat-icon class="step-icon">check_circle_outline</mat-icon>
                <span>{{ step | transloco }}</span>
              </div>
            }
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Feedback Modal -->
  @if (showFeedbackModal()) {
    <div class="modal-overlay" (click)="toggleFeedbackModal()">
      <div class="modal-content feedback-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>‚≠ê Rate Your Experience</h2>
          <button class="close-button" (click)="toggleFeedbackModal()">‚úï</button>
        </div>

        <div class="modal-body">
          <div class="feedback-form">
            <!-- Rating -->
            <div class="feedback-section">
              <label>Rating (1-5 stars)</label>
              <div class="star-rating">
                @for (star of [1, 2, 3, 4, 5]; track star) {
                  <button
                    type="button"
                    class="star-button"
                    [class.active]="feedbackRating() >= star"
                    (click)="setRating(star)"
                  >
                    ‚≠ê
                  </button>
                }
              </div>
              <div class="rating-text">
                @if (feedbackRating() > 0) {
                  {{ feedbackRating() }} {{ feedbackRating() === 1 ? 'star' : 'stars' }}
                } @else {
                  Select a rating
                }
              </div>
            </div>

            <!-- Tags -->
            <div class="feedback-section">
              <label>Tags (optional)</label>
              <div class="tags-list">
                @for (tag of availableTags; track tag) {
                  <button
                    type="button"
                    class="tag-button"
                    [class.selected]="feedbackTags().includes(tag)"
                    (click)="toggleTag(tag)"
                  >
                    {{ tag }}
                  </button>
                }
              </div>
            </div>

            <!-- Comment -->
            <div class="feedback-section">
              <label>Comment (optional)</label>
              <textarea
                [(ngModel)]="feedbackComment"
                placeholder="Share your experience..."
                class="feedback-comment"
                rows="4"
              ></textarea>
            </div>

            @if (lastPaymentTx()) {
              <div class="payment-link-info">
                üîó Your feedback will be linked to payment transaction:
                <code>{{ lastPaymentTx() }}</code>
              </div>
            }

            <!-- Submit Button -->
            <div class="feedback-actions">
              <button
                class="submit-feedback-button"
                (click)="submitFeedback()"
                [disabled]="feedbackRating() === 0 || isSubmittingFeedback()"
              >
                @if (isSubmittingFeedback()) {
                  Submitting...
                } @else {
                  Submit Feedback
                }
              </button>
              <button class="cancel-button" (click)="toggleFeedbackModal()">Cancel</button>
            </div>

            <div class="feedback-note">
              üí° Your feedback will be recorded on-chain via ERC8004 Reputation Registry
            </div>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- Input Area (Footer) -->
  <div class="border-t border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-4">
    <div class="max-w-4xl mx-auto flex gap-3 items-center">
      <input
        [(ngModel)]="userInput"
        (keyup.enter)="sendMessage()"
        type="text"
        placeholder="Type your request (e.g., 'Validate ID 12345678')..."
        class="flex-1 h-12 px-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all placeholder:text-slate-400"
      />
      <button
        (click)="sendMessage()"
        [disabled]="isLoading() || !userInput().trim()"
        class="h-12 w-12 flex items-center justify-center rounded-xl bg-slate-900 dark:bg-white text-white dark:text-slate-900 hover:bg-slate-800 dark:hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm"
      >
        <mat-icon *ngIf="!isLoading()">arrow_upward</mat-icon>
        <mat-progress-spinner
          *ngIf="isLoading()"
          diameter="20"
          mode="indeterminate"
        ></mat-progress-spinner>
      </button>
    </div>
  </div>

  <!-- Payment Confirmation Modal -->
  @if (showPaymentConfirmationModal()) {
    <div class="modal-overlay" (click)="cancelPayment()">
      <div class="modal-content payment-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Confirm Payment</h2>
          <button class="close-button" (click)="cancelPayment()">‚úï</button>
        </div>

        <div class="modal-body p-6">
          <div class="payment-summary text-center">
            <div
              class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-full mx-auto flex items-center justify-center mb-4"
            >
              <mat-icon class="text-blue-600 dark:text-blue-400 !w-8 !h-8 !text-[32px]"
                >account_balance_wallet</mat-icon
              >
            </div>

            <p class="text-slate-500 dark:text-slate-400 mb-2">You are about to pay</p>
            <h1 class="text-3xl font-bold mb-1 text-slate-900 dark:text-white">
              {{ pendingPayment()?.amount | number: '1.5-5' }} AVAX
            </h1>
            <p class="text-sm text-slate-400 mb-6" *ngIf="pendingPayment()?.priceUsd">
              ‚âà ${{ pendingPayment()?.priceUsd }} USD
            </p>

            <div
              class="payment-details bg-slate-50 dark:bg-slate-800 rounded-lg p-4 mb-6 text-left border border-slate-200 dark:border-slate-700"
            >
              <div class="detail-row flex justify-between mb-2">
                <span class="text-slate-500 dark:text-slate-400">To:</span>
                <span
                  class="font-mono text-xs text-right text-slate-700 dark:text-slate-300 break-all pl-4"
                  >{{ pendingPayment()?.receiver_address }}</span
                >
              </div>
              <div
                class="detail-row flex justify-between mb-2 cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-700/50 rounded px-1 -mx-1 transition-colors"
                (click)="togglePaymentDetails()"
              >
                <span class="text-slate-500 dark:text-slate-400 flex items-center gap-1">
                  Service
                </span>
                <div class="flex items-center gap-1 text-right text-slate-700 dark:text-slate-300">
                  <span class="font-medium">Verifik Premium Data</span>
                  <mat-icon
                    class="!w-4 !h-4 !text-[16px] transition-transform"
                    [class.rotate-90]="showPaymentDetails()"
                    >chevron_right</mat-icon
                  >
                </div>
              </div>

              @if (showPaymentDetails()) {
                <div
                  class="mt-2 mb-2 p-3 bg-slate-100 dark:bg-slate-900/50 rounded text-xs space-y-1 animate-fadeIn"
                >
                  <div class="flex flex-col gap-1">
                    <span class="text-slate-500 font-semibold">Endpoint:</span>
                    <span class="font-mono break-all text-slate-700 dark:text-slate-300">{{
                      pendingPayment()?.endpoint || 'N/A'
                    }}</span>
                  </div>
                  <div class="flex flex-col gap-1 mt-2">
                    <span class="text-slate-500 font-semibold">Tool:</span>
                    <span class="font-mono break-all text-slate-700 dark:text-slate-300">{{
                      pendingPayment()?.toolName || 'N/A'
                    }}</span>
                  </div>
                </div>
              }

              <div class="detail-row flex justify-between">
                <span class="text-slate-500 dark:text-slate-400">Network:</span>
                <span class="font-medium text-right text-slate-700 dark:text-slate-300"
                  >Avalanche C-Chain</span
                >
              </div>
            </div>

            <button
              mat-flat-button
              color="primary"
              class="w-full !h-12 !rounded-lg !text-lg mb-3 bg-blue-600 text-white hover:bg-blue-700"
              [disabled]="isProcessingPayment()"
              (click)="executePayment()"
            >
              <span *ngIf="!isProcessingPayment()">Confirm Payment</span>
              <div *ngIf="isProcessingPayment()" class="flex items-center justify-center gap-2">
                <mat-progress-spinner
                  diameter="20"
                  mode="indeterminate"
                  class="text-white"
                ></mat-progress-spinner>
                <span>Processing...</span>
              </div>
            </button>

            <button
              mat-stroked-button
              class="w-full !h-12 !rounded-lg border border-slate-300 dark:border-slate-600"
              [disabled]="isProcessingPayment()"
              (click)="cancelPayment()"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</div>

<!-- Toast Notification -->
@if (showToast()) {
  <div class="toast-notification animate-slideUpFade">
    <div class="toast-content">
      <mat-icon class="toast-icon">check_circle</mat-icon>
      <span>{{ toastMessage() }}</span>
    </div>
  </div>
}
