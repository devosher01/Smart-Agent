<div class="w-full max-w-sm mx-auto p-2">
  <!-- Header -->
  <div class="text-center mb-8">
    <!-- Logo or brand -->
    <h2 class="text-xl font-bold text-slate-900 dark:text-white">
      {{
        (state() === 'WALLET_ENCRYPT_CHOICE' || state() === 'WALLET_ENCRYPT_PIN'
          ? 'authModal.header.secureWallet'
          : 'authModal.header.login'
        ) | transloco
      }}
    </h2>
  </div>

  <!-- Error Message -->
  <div *ngIf="error() || errorKey()" class="mb-4 p-3 bg-red-100 text-red-700 rounded-md text-sm text-center">
    <span *ngIf="errorKey()">{{ errorKey() | transloco }}</span>
    <span *ngIf="!errorKey() && error()">{{ error() }}</span>
  </div>

  <!-- CHOICE State -->
  <div *ngIf="state() === 'CHOICE'" class="space-y-3">
    <!-- Only show email/SMS options if user doesn't have Web2 auth -->
    <ng-container *ngIf="!hasWeb2Auth()">
      <button
        mat-stroked-button
        class="w-full !h-12 !justify-start !px-4 !rounded-lg !border-slate-300 dark:!border-slate-700"
        (click)="startEmailFlow()"
      >
        <mat-icon class="mr-3 text-slate-500">mail</mat-icon>
        <span class="text-slate-700 dark:text-slate-300">{{
          'authModal.choice.continueEmail' | transloco
        }}</span>
      </button>

      <button
        mat-stroked-button
        class="w-full !h-12 !justify-start !px-4 !rounded-lg !border-slate-300 dark:!border-slate-700"
        (click)="startPhoneFlow()"
      >
        <mat-icon class="mr-3 text-slate-500">smartphone</mat-icon>
        <span class="text-slate-700 dark:text-slate-300">{{
          'authModal.choice.continueSMS' | transloco
        }}</span>
      </button>

      <div class="relative py-2">
        <div class="absolute inset-0 flex items-center">
          <div class="w-full border-t border-slate-200 dark:border-slate-700"></div>
        </div>
        <div class="relative flex justify-center text-xs uppercase">
          <span class="bg-white dark:bg-slate-800 px-2 text-slate-500">{{
            'authModal.choice.or' | transloco
          }}</span>
        </div>
      </div>
    </ng-container>

    <!-- Wallet Option -->
    <ng-container *ngIf="!connectedWalletAddress(); else connectedWallet">
      <button
        mat-stroked-button
        class="w-full !h-12 !justify-start !px-4 !rounded-lg !border-slate-300 dark:!border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors"
        (click)="startWalletFlow()"
      >
        <div class="flex items-center w-full">
          <mat-icon class="mr-3 text-slate-500">account_balance_wallet</mat-icon>
          <span class="text-slate-700 dark:text-slate-300">{{
            'authModal.choice.continueWallet' | transloco
          }}</span>
        </div>
      </button>
    </ng-container>

    <!-- Already Connected Wallet State -->
    <ng-template #connectedWallet>
      <div
        class="w-full h-12 px-4 rounded-lg border border-green-200 dark:border-green-800 bg-green-50 dark:bg-green-900/10 flex items-center justify-between cursor-default"
      >
        <div class="flex items-center gap-3">
          <mat-icon class="text-green-600 dark:text-green-400">check_circle</mat-icon>
          <div class="flex flex-col">
            <span class="text-xs font-semibold text-green-700 dark:text-green-300">{{
              'authModal.walletConnected.title' | transloco
            }}</span>
            <span class="text-[10px] font-mono text-green-600 dark:text-green-400 opacity-80">
              {{ connectedWalletAddress()?.substring(0, 6) }}...{{
                connectedWalletAddress()?.substring(38)
              }}
            </span>
          </div>
        </div>
      </div>
    </ng-template>

    <!-- Only show sign up prompt if user doesn't have Web2 auth -->
    <div *ngIf="!hasWeb2Auth()" class="pt-4 text-center">
      <span class="text-sm text-slate-500">{{ 'authModal.choice.noAccount' | transloco }}</span>
      <a
        class="text-sm text-blue-600 font-semibold ml-1 cursor-pointer hover:underline"
        href="https://access.verifik.co/sign-up/6332941ccde4f719d9c00f9e"
        >{{ 'authModal.choice.signUp' | transloco }}</a
      >
    </div>
  </div>

  <!-- EMAIL INPUT State -->
  <div *ngIf="state() === 'EMAIL_INPUT'" class="space-y-4">
    <!-- Info Message -->
    <div
      class="p-3 bg-blue-50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-900/20 rounded-lg flex gap-3"
    >
      <mat-icon class="text-blue-500 !w-5 !h-5 !text-[20px] shrink-0 mt-0.5">info</mat-icon>
      <p
        class="text-xs text-blue-700 dark:text-blue-300 leading-snug"
        [innerHTML]="'authModal.emailInput.infoMessage' | transloco"
      ></p>
    </div>

    <div class="relative">
      <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">mail</mat-icon>
      <input
        [ngModel]="email()"
        (ngModelChange)="email.set($event)"
        type="email"
        [placeholder]="'authModal.emailInput.placeholder' | transloco"
        class="w-full pl-10 pr-4 py-3 rounded-lg border border-slate-300 dark:border-slate-700 bg-transparent focus:ring-2 focus:ring-blue-500 focus:outline-none"
        (keyup.enter)="sendEmailOtp()"
      />
    </div>

    <button
      mat-flat-button
      color="primary"
      class="w-full !h-11 !rounded-lg"
      [disabled]="!isEmailValid || isLoading()"
      (click)="sendEmailOtp()"
    >
      <span *ngIf="!isLoading()">{{ 'authModal.emailInput.continue' | transloco }}</span>
      <mat-progress-spinner
        *ngIf="isLoading()"
        diameter="20"
        mode="indeterminate"
      ></mat-progress-spinner>
    </button>

    <button mat-button class="w-full" (click)="setState('CHOICE')">
      {{ 'authModal.emailInput.back' | transloco }}
    </button>
  </div>

  <!-- PHONE INPUT State -->
  <div *ngIf="state() === 'PHONE_INPUT'" class="space-y-4">
    <!-- Info Message -->
    <div
      class="p-3 bg-blue-50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-900/20 rounded-lg flex gap-3"
    >
      <mat-icon class="text-blue-500 !w-5 !h-5 !text-[20px] shrink-0 mt-0.5">info</mat-icon>
      <p
        class="text-xs text-blue-700 dark:text-blue-300 leading-snug"
        [innerHTML]="'authModal.phoneInput.infoMessage' | transloco"
      ></p>
    </div>

    <div class="flex space-x-2">
      <!-- Country Code Selector -->
      <div class="relative country-selector-container">
        <button
          #countryButton
          type="button"
          (click)="toggleCountryDropdown()"
          class="w-28 px-3 py-3 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 flex items-center justify-between hover:bg-slate-50 dark:hover:bg-slate-700 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-colors"
        >
          <span class="flex items-center gap-2 text-sm">
            <span *ngIf="selectedCountry()">{{ selectedCountry()!.flag }}</span>
            <span *ngIf="selectedCountry()" class="font-medium">{{
              selectedCountry()!.dialCode
            }}</span>
            <span *ngIf="!selectedCountry()" class="text-slate-400">{{
              'authModal.phoneInput.selectCountry' | transloco
            }}</span>
          </span>
          <mat-icon class="!w-4 !h-4 !text-[16px] text-slate-400">arrow_drop_down</mat-icon>
        </button>

        <!-- Dropdown Menu -->
        <div
          *ngIf="isCountryDropdownOpen() && dropdownPosition()"
          class="fixed z-[1000] w-80 max-h-80 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg shadow-lg overflow-hidden"
          [style.top]="dropdownPosition()!.top"
          [style.left]="dropdownPosition()!.left"
        >
          <!-- Search Input -->
          <div class="p-2 border-b border-slate-200 dark:border-slate-700">
            <div class="relative">
              <mat-icon
                class="absolute left-2 top-1/2 -translate-y-1/2 !w-4 !h-4 !text-[16px] text-slate-400"
                >search</mat-icon
              >
              <input
                type="text"
                [value]="countrySearchTerm()"
                (input)="onCountrySearchChange($any($event.target).value)"
                [placeholder]="'authModal.phoneInput.searchCountry' | transloco"
                class="w-full pl-8 pr-3 py-2 text-sm rounded-md border border-slate-300 dark:border-slate-600 bg-transparent focus:ring-2 focus:ring-blue-500 focus:outline-none"
                (click)="$event.stopPropagation()"
              />
            </div>
          </div>

          <!-- Country List -->
          <div class="max-h-64 overflow-y-auto">
            <button
              *ngFor="let country of filteredCountries()"
              type="button"
              (click)="selectCountry(country)"
              class="w-full px-4 py-3 flex items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700 text-left transition-colors"
              [class.bg-blue-50]="selectedCountry()?.dialCode === country.dialCode"
            >
              <span class="text-2xl">{{ country.flag }}</span>
              <div class="flex-1 min-w-0">
                <div class="text-sm font-medium text-slate-900 dark:text-slate-100 truncate">
                  {{ country.name }}
                </div>
              </div>
              <span class="text-sm text-slate-500 dark:text-slate-400 font-medium">
                {{ country.dialCode }}
              </span>
            </button>
            <div
              *ngIf="filteredCountries().length === 0"
              class="px-4 py-3 text-sm text-slate-500 text-center"
            >
              {{ 'authModal.phoneInput.noCountries' | transloco }}
            </div>
          </div>
        </div>
      </div>

      <!-- Phone Input -->
      <input
        [ngModel]="phone()"
        (input)="onPhoneInput($event)"
        type="tel"
        [placeholder]="'authModal.phoneInput.phonePlaceholder' | transloco"
        class="flex-1 px-4 py-3 rounded-lg border border-slate-300 dark:border-slate-700 bg-transparent focus:ring-2 focus:ring-blue-500 focus:outline-none"
        (keyup.enter)="sendPhoneOtp()"
      />
    </div>

    <button
      mat-flat-button
      color="primary"
      class="w-full !h-11 !rounded-lg"
      [disabled]="!phone() || !selectedCountry() || isLoading()"
      (click)="sendPhoneOtp()"
    >
      <span *ngIf="!isLoading()">{{ 'authModal.phoneInput.continue' | transloco }}</span>
      <mat-progress-spinner
        *ngIf="isLoading()"
        diameter="20"
        mode="indeterminate"
      ></mat-progress-spinner>
    </button>

    <button mat-button class="w-full" (click)="setState('CHOICE')">
      {{ 'authModal.phoneInput.back' | transloco }}
    </button>
  </div>

  <!-- OTP State (Email or Phone) -->
  <div *ngIf="state() === 'OTP_VERIFY_EMAIL' || state() === 'OTP_VERIFY_PHONE'" class="space-y-6">
    <div class="text-center space-y-2">
      <h3 class="font-bold">{{ 'authModal.otpVerify.title' | transloco }}</h3>
      <p class="text-sm text-slate-500">
        {{
          (state() === 'OTP_VERIFY_EMAIL'
            ? 'authModal.otpVerify.emailMessage'
            : 'authModal.otpVerify.phoneMessage'
          ) | transloco: { email: email(), phone: phone() }
        }}
      </p>
    </div>

    <div class="flex justify-between gap-2">
      <input
        *ngFor="let digit of otpArray(); let i = index"
        [id]="'otp-' + i"
        type="text"
        inputmode="numeric"
        maxlength="1"
        [value]="digit"
        (input)="onOtpInput($event, i)"
        (keydown)="onKeyDown($event, i)"
        class="w-12 h-14 text-center text-2xl font-bold rounded-lg border border-slate-300 dark:border-slate-700 bg-transparent focus:ring-2 focus:ring-blue-500 focus:outline-none"
      />
    </div>

    <button
      mat-flat-button
      color="primary"
      class="w-full !h-11 !rounded-lg"
      [disabled]="otpArray().join('').length !== 6 || isLoading()"
      (click)="state() === 'OTP_VERIFY_EMAIL' ? verifyEmailOtp() : verifyPhoneOtp()"
    >
      <span *ngIf="!isLoading()">{{ 'authModal.otpVerify.verify' | transloco }}</span>
      <mat-progress-spinner
        *ngIf="isLoading()"
        diameter="20"
        mode="indeterminate"
      ></mat-progress-spinner>
    </button>

    <button mat-button class="w-full" (click)="setState('CHOICE')">
      {{ 'authModal.otpVerify.back' | transloco }}
    </button>
  </div>

  <!-- Wallet State -->
  <div *ngIf="state() === 'WALLET_CONNECT'" class="space-y-4">
    <h3 class="font-bold text-center">{{ 'authModal.walletConnect.title' | transloco }}</h3>
    <p class="text-xs text-center text-slate-500 mb-4">
      {{ 'authModal.walletConnect.subtitle' | transloco }}
    </p>

    <div class="space-y-2">
      <!-- <button mat-stroked-button class="w-full !h-12 !justify-start !px-4 !rounded-lg">
        <span>{{ 'authModal.walletConnect.zelf' | transloco }}</span>
      </button> -->
      <button
        mat-stroked-button
        class="w-full !h-12 !justify-start !px-4 !rounded-lg"
        (click)="connectMetaMask()"
        [disabled]="isLoading()"
      >
        <span>{{ 'authModal.walletConnect.metamask' | transloco }}</span>
      </button>
      <!-- <button mat-stroked-button class="w-full !h-12 !justify-start !px-4 !rounded-lg">
        <span>{{ 'authModal.walletConnect.walletConnect' | transloco }}</span>
      </button> -->

      <!-- Fake Agent Wallet Option -->
      <button
        mat-stroked-button
        class="w-full !h-12 !justify-start !px-4 !rounded-lg bg-slate-50 dark:bg-slate-800"
        (click)="createAgentWallet()"
      >
        <span>{{ 'authModal.walletConnect.createAgent' | transloco }}</span>
      </button>
    </div>

    <button mat-button class="w-full" (click)="handleWalletBack()">
      {{ 'authModal.walletConnect.back' | transloco }}
    </button>
  </div>

  <!-- Wallet Encryption Choice State -->
  <div *ngIf="state() === 'WALLET_ENCRYPT_CHOICE'" class="space-y-6">
    <!-- Wallet Identity Badge -->
    <div class="flex flex-col items-center gap-3 mb-2">
      <!-- Placeholder Avatar -->
      <div
        class="w-20 h-20 rounded-full bg-gradient-to-br from-indigo-50 to-blue-50 dark:from-indigo-900/20 dark:to-blue-900/20 flex items-center justify-center shadow-inner"
      >
        <mat-icon class="text-indigo-500 !w-10 !h-10 !text-[40px]">account_balance_wallet</mat-icon>
      </div>

      <!-- Address Chip -->
      <div
        class="flex items-center gap-2 px-3 py-1.5 bg-slate-100 dark:bg-slate-800 rounded-full border border-slate-200 dark:border-slate-700"
      >
        <span class="w-2 h-2 rounded-full bg-green-500"></span>
        <span class="text-xs font-mono text-slate-600 dark:text-slate-300">
          {{ tempWalletAddress()?.substring(0, 6) }}...{{ tempWalletAddress()?.substring(38) }}
        </span>
      </div>
    </div>

    <!-- Instruction Text -->
    <div class="text-center px-2">
      <p
        class="text-sm leading-relaxed text-slate-600 dark:text-slate-400"
        [innerHTML]="'authModal.walletEncrypt.instruction' | transloco"
      ></p>
    </div>

    <!-- Action Buttons -->
    <div class="space-y-3 pt-2">
      <!-- Passkey Option -->
      <button
        *ngIf="passkeySupported()"
        mat-flat-button
        color="primary"
        class="w-full !h-12 !rounded-lg !text-base shadow-lg shadow-indigo-500/20"
        (click)="encryptWithPasskey()"
        [disabled]="isLoading()"
      >
        <div class="flex items-center justify-center gap-2">
          <mat-icon class="!w-5 !h-5 !text-[20px]">fingerprint</mat-icon>
          <span>{{ 'authModal.walletEncrypt.createPasskey' | transloco }}</span>
        </div>
      </button>

      <!-- PIN Option -->
      <button
        mat-stroked-button
        class="w-full !h-12 !rounded-lg !text-base !border-slate-300 dark:!border-slate-700 hover:!bg-slate-50 dark:hover:!bg-slate-800 transition-colors"
        (click)="usePINInstead()"
        [disabled]="isLoading()"
      >
        <div class="flex items-center justify-center gap-2">
          <mat-icon class="!w-5 !h-5 !text-[20px] text-slate-500">pin</mat-icon>
          <span class="text-slate-700 dark:text-slate-300">
            {{ 'authModal.walletEncrypt.usePIN' | transloco }}
          </span>
        </div>
      </button>
    </div>

    <!-- Not Supported Warning -->
    <div *ngIf="!passkeySupported()" class="text-center">
      <p class="text-xs text-amber-600 dark:text-amber-500">
        {{ 'authModal.walletEncrypt.notSupported' | transloco }}
      </p>
    </div>

    <!-- Loading -->
    <div *ngIf="isLoading()" class="flex justify-center py-2">
      <mat-progress-spinner diameter="24" mode="indeterminate"></mat-progress-spinner>
    </div>
  </div>

  <!-- Wallet Encryption PIN State -->
  <div *ngIf="state() === 'WALLET_ENCRYPT_PIN'" class="space-y-6">
    <div class="text-center space-y-2">
      <div
        class="w-12 h-12 bg-indigo-100 dark:bg-indigo-900/30 rounded-full mx-auto flex items-center justify-center mb-4"
      >
        <mat-icon class="text-indigo-600 dark:text-indigo-400 !w-6 !h-6 !text-[24px]">pin</mat-icon>
      </div>
      <h3 class="font-bold">{{ 'authModal.pinSetup.title' | transloco }}</h3>
      <p class="text-sm text-slate-500">
        {{ 'authModal.pinSetup.subtitle' | transloco }}
      </p>
    </div>

    <div
      class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3"
    >
      <div class="flex items-start gap-2">
        <mat-icon class="text-amber-600 dark:text-amber-400 !w-4 !h-4 !text-[16px] mt-0.5"
          >warning</mat-icon
        >
        <p
          class="text-xs text-amber-700 dark:text-amber-300"
          [innerHTML]="'authModal.pinSetup.warning' | transloco"
        ></p>
      </div>
    </div>

    <div class="flex justify-between gap-2">
      <input
        *ngFor="let digit of pinArray(); let i = index"
        [id]="'pin-' + i"
        type="password"
        inputmode="numeric"
        maxlength="1"
        [value]="digit"
        (input)="onPinInput($event, i)"
        (keydown)="onPinKeyDown($event, i)"
        class="w-12 h-14 text-center text-2xl font-bold rounded-lg border border-slate-300 dark:border-slate-700 bg-transparent focus:ring-2 focus:ring-indigo-500 focus:outline-none"
      />
    </div>

    <button
      mat-flat-button
      color="primary"
      class="w-full !h-11 !rounded-lg"
      [disabled]="pinArray().join('').length !== 6 || isLoading()"
      (click)="encryptWithPIN()"
    >
      <span *ngIf="!isLoading()">{{ 'authModal.pinSetup.encryptWallet' | transloco }}</span>
      <mat-progress-spinner
        *ngIf="isLoading()"
        diameter="20"
        mode="indeterminate"
      ></mat-progress-spinner>
    </button>

    <button mat-button class="w-full" (click)="setState('WALLET_ENCRYPT_CHOICE')">
      {{ 'authModal.pinSetup.back' | transloco }}
    </button>
  </div>

  <div class="mt-8 text-center text-[10px] text-slate-400">
    {{ 'authModal.footer.protectedBy' | transloco }}
  </div>
</div>
