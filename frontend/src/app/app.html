<div class="chat-container">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="avatar" (click)="toggleAgentInfoModal()" title="Click to view agent identity">
        @if (agentInfo()?.identity) {
        <span class="nft-badge">NFT</span>
        } AI
      </div>
      <div>
        <h1 (click)="toggleAgentInfoModal()" style="cursor: pointer">
          {{ agentInfo()?.identity?.name || 'Verifik Agent' }}
        </h1>
        <p class="subtitle">
          @if (agentInfo()?.identity) {
          {{ agentInfo()?.identity?.description }}
          } @else { Powered by Gemini & x402 on Avalanche }
        </p>
        @if (agentInfo()?.reputation) {
        <div class="reputation-badge">
          ‚≠ê {{ agentInfo()?.reputation?.averageRating?.toFixed(1) || 'N/A' }} ({{
            agentInfo()?.reputation?.totalFeedbacks || 0
          }}
          reviews)
        </div>
        }
      </div>
    </div>

    <!-- Wallet Info -->
    <div class="wallet-info" (click)="toggleWalletModal()" title="Click to view details">
      <div class="wallet-label">Agent Wallet üëõ</div>
      <div class="wallet-balance">{{ walletBalance() | number : '1.4-4' }} AVAX</div>
      <div class="wallet-address" [title]="walletAddress()">{{ walletAddress() }}</div>
    </div>
  </div>

  <!-- Agent Info Modal (ERC8004) -->
  @if (showAgentInfoModal()) {
  <div class="modal-overlay" (click)="toggleAgentInfoModal()">
    <div class="modal-content agent-info-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>ü§ñ Agent Identity (ERC8004)</h2>
        <button class="close-button" (click)="toggleAgentInfoModal()">‚úï</button>
      </div>

      <div class="modal-body">
        @if (isLoadingAgentInfo()) {
        <div class="loading-state">Loading agent information...</div>
        } @else if (agentInfo()?.identity) {
        <div class="agent-identity">
          <div class="identity-section">
            <h3>üìã Identity</h3>
            <div class="detail-item">
              <label>Name</label>
              <div class="detail-value">{{ agentInfo()?.identity?.name }}</div>
            </div>
            <div class="detail-item">
              <label>Description</label>
              <div class="detail-value">{{ agentInfo()?.identity?.description }}</div>
            </div>
            <div class="detail-item">
              <label>Status</label>
              <div class="detail-value">
                <span [class]="agentInfo()?.identity?.active ? 'status-active' : 'status-inactive'">
                  {{ agentInfo()?.identity?.active ? '‚úÖ Active' : '‚ùå Inactive' }}
                </span>
              </div>
            </div>
            <div class="detail-item">
              <label>Agent Address</label>
              <div class="detail-value">
                <code>{{ agentInfo()?.identity?.agentAddress }}</code>
              </div>
            </div>
            <div class="detail-item">
              <label>Registered</label>
              <div class="detail-value">
                {{ agentInfo()?.identity?.createdAt | date : 'medium' }}
              </div>
            </div>
          </div>

          <div class="identity-section">
            <h3>üõ†Ô∏è Capabilities</h3>
            <div class="capabilities-list">
              @for (cap of agentInfo()?.identity?.capabilities; track cap) {
              <span class="capability-badge">{{ cap }}</span>
              }
            </div>
          </div>

          @if (agentInfo()?.reputation) {
          <div class="identity-section">
            <h3>‚≠ê Reputation</h3>
            <div class="reputation-stats">
              <div class="stat-item">
                <label>Average Rating</label>
                <div class="stat-value">
                  <strong>{{ agentInfo()?.reputation?.averageRating?.toFixed(2) || 'N/A' }}</strong>
                  / 5.0
                </div>
              </div>
              <div class="stat-item">
                <label>Total Reviews</label>
                <div class="stat-value">
                  <strong>{{ agentInfo()?.reputation?.totalFeedbacks || 0 }}</strong>
                </div>
              </div>
              <div class="stat-item">
                <label>Total Ratings</label>
                <div class="stat-value">
                  <strong>{{ agentInfo()?.reputation?.totalRatings || 0 }}</strong>
                </div>
              </div>
            </div>
          </div>
          } @if (agentInfo()?.feedbacks && agentInfo()?.feedbacks!.length > 0) {
          <div class="identity-section">
            <h3>üìù Recent Reviews</h3>
            <div class="feedbacks-list">
              @for (feedback of agentInfo()?.feedbacks; track feedback.id) {
              <div class="feedback-item">
                <div class="feedback-header">
                  <div class="feedback-rating">
                    @for (star of [1,2,3,4,5]; track star) {
                    <span [class.filled]="star <= feedback.rating">‚≠ê</span>
                    }
                  </div>
                  <div class="feedback-meta">
                    <span class="feedback-address"
                      >{{ feedback.client.substring(0, 6) }}...{{
                        feedback.client.substring(38)
                      }}</span
                    >
                    <span class="feedback-date">{{ feedback.timestamp | date : 'short' }}</span>
                    @if (feedback.verified) {
                    <span class="verified-badge">‚úì Verified</span>
                    }
                  </div>
                </div>
                @if (feedback.tags && feedback.tags.length > 0) {
                <div class="feedback-tags">
                  @for (tag of feedback.tags; track tag) {
                  <span class="tag-small">{{ tag }}</span>
                  }
                </div>
                } @if (feedback.comment) {
                <div class="feedback-comment-text">{{ feedback.comment }}</div>
                }
              </div>
              }
            </div>
            <div class="view-all-link">
              <a
                href="https://testnet.snowtrace.io/address/0xc8AF65010D6Bf85e4DC89D9D13E9cC185df919B1#readContract"
                target="_blank"
                class="link-button-small"
              >
                üîç View All on Snowtrace
              </a>
            </div>
          </div>
          }

          <div class="identity-section">
            <h3>üîó Links</h3>
            <div class="links-list">
              <a
                href="https://testnet.snowtrace.io/token/0x7c6a168455C94092f8d51aBC515B73f4Ed9813a6?a=1"
                target="_blank"
                class="link-button"
              >
                üîç View NFT on Snowtrace
              </a>
              <a href="https://verifik.app/agent-card.json" target="_blank" class="link-button">
                üìÑ Agent Card JSON
              </a>
            </div>
          </div>
        </div>
        } @else {
        <div class="no-info">
          <p>Agent identity not available. The agent may not be registered on ERC8004.</p>
        </div>
        }
      </div>
    </div>
  </div>
  }

  <!-- Wallet Modal -->
  @if (showWalletModal()) {
  <div class="modal-overlay" (click)="toggleWalletModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Agent Wallet Details</h2>
        <button class="close-button" (click)="toggleWalletModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="wallet-detail">
          <label>Address</label>
          <div class="detail-value">
            <code>{{ walletAddress() }}</code>
            <button class="copy-button" (click)="copyAddress()">üìã Copy</button>
          </div>
        </div>

        <div class="wallet-detail">
          <label>Balance</label>
          <div class="detail-value">
            <strong>{{ walletBalance() }} AVAX</strong>
          </div>
        </div>

        <div class="wallet-detail">
          <label>Network</label>
          <div class="detail-value">Avalanche C-Chain (Fuji Testnet) ‚úÖ</div>
        </div>

        <div class="wallet-detail">
          <label>Storage</label>
          <div class="detail-value">Private key stored in browser localStorage</div>
        </div>

        <div class="wallet-actions">
          <button class="action-button refresh" (click)="refreshBalance()">
            üîÑ Refresh Balance
          </button>
          <button class="action-button danger" (click)="resetWallet()">‚ö†Ô∏è Reset Wallet</button>
        </div>

        <div class="wallet-warning">
          ‚ö†Ô∏è This is a burner wallet for demo purposes. Do not send large amounts of AVAX.
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Chat Area -->
  <div class="messages" #scrollContainer>
    @for (msg of messages(); track $index) {
    <div class="message" [class.user]="msg.role === 'user'" [class.system]="msg.role === 'system'">
      <div class="message-bubble">
        <!-- Message Content -->
        <div class="message-content">{{ msg.content }}</div>

        <!-- Payment Request -->
        @if (msg.payment_required) {
        <div class="payment-request">
          <div class="payment-header"><span class="icon">‚ö°</span> Payment Required</div>
          <div class="payment-amount">
            Amount: <strong>{{ msg.payment_required.amount }} AVAX</strong>
          </div>
          <div class="payment-to">To: {{ msg.payment_required.receiver_address }}</div>
          <button class="pay-button" (click)="confirmPayment($index)">Pay & Proceed</button>
        </div>
        }

        <!-- Data Display -->
        @if (msg.data) {
        <div class="data-display">
          <pre>{{ msg.data | json }}</pre>
        </div>

        <!-- Feedback Button (show after successful tool execution) -->
        @if (msg.role === 'assistant' && msg.data) {
        <div class="feedback-prompt">
          <p>Was this helpful?</p>
          <button class="feedback-button" (click)="toggleFeedbackModal()">‚≠ê Rate & Review</button>
        </div>
        } }
      </div>
    </div>
    }

    <!-- Loading Indicator -->
    @if (isLoading()) {
    <div class="message">
      <div class="message-bubble loading">
        <div class="loading-dots">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
      </div>
    </div>
    }
  </div>

  <!-- Feedback Modal -->
  @if (showFeedbackModal()) {
  <div class="modal-overlay" (click)="toggleFeedbackModal()">
    <div class="modal-content feedback-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>‚≠ê Rate Your Experience</h2>
        <button class="close-button" (click)="toggleFeedbackModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="feedback-form">
          <!-- Rating -->
          <div class="feedback-section">
            <label>Rating (1-5 stars)</label>
            <div class="star-rating">
              @for (star of [1,2,3,4,5]; track star) {
              <button
                type="button"
                class="star-button"
                [class.active]="feedbackRating() >= star"
                (click)="setRating(star)"
              >
                ‚≠ê
              </button>
              }
            </div>
            <div class="rating-text">
              @if (feedbackRating() > 0) {
              {{ feedbackRating() }} {{ feedbackRating() === 1 ? 'star' : 'stars' }}
              } @else { Select a rating }
            </div>
          </div>

          <!-- Tags -->
          <div class="feedback-section">
            <label>Tags (optional)</label>
            <div class="tags-list">
              @for (tag of availableTags; track tag) {
              <button
                type="button"
                class="tag-button"
                [class.selected]="feedbackTags().includes(tag)"
                (click)="toggleTag(tag)"
              >
                {{ tag }}
              </button>
              }
            </div>
          </div>

          <!-- Comment -->
          <div class="feedback-section">
            <label>Comment (optional)</label>
            <textarea
              [(ngModel)]="feedbackComment"
              placeholder="Share your experience..."
              class="feedback-comment"
              rows="4"
            ></textarea>
          </div>

          @if (lastPaymentTx()) {
          <div class="payment-link-info">
            üîó Your feedback will be linked to payment transaction:
            <code>{{ lastPaymentTx() }}</code>
          </div>
          }

          <!-- Submit Button -->
          <div class="feedback-actions">
            <button
              class="submit-feedback-button"
              (click)="submitFeedback()"
              [disabled]="feedbackRating() === 0 || isSubmittingFeedback()"
            >
              @if (isSubmittingFeedback()) { Submitting... } @else { Submit Feedback }
            </button>
            <button class="cancel-button" (click)="toggleFeedbackModal()">Cancel</button>
          </div>

          <div class="feedback-note">
            üí° Your feedback will be recorded on-chain via ERC8004 Reputation Registry
          </div>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Input Area -->
  <div class="input-area">
    <input
      [(ngModel)]="userInput"
      (keyup.enter)="sendMessage()"
      type="text"
      placeholder="Type your request (e.g., 'Validate ID 12345678')..."
      class="message-input"
    />
    <button
      (click)="sendMessage()"
      [disabled]="isLoading() || !userInput().trim()"
      class="send-button"
    >
      Send
    </button>
  </div>
</div>
